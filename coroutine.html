<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.c6{background-color:#ffffff;max-width:451.4pt;padding:72pt 72pt 72pt 72pt}.c3{color:#1155cc;text-decoration:underline}.c1{orphans:2;widows:2}.c5{color:inherit;text-decoration:inherit}.c2{height:11pt}.c8{text-indent:36pt}.c4{font-weight:700}.c7{text-align:center}.c0{font-family:"Courier New"}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c6"><p class="c1 c7"><span class="c4 c0">&#21327;&#31243;&#24211;coroutine&#28304;&#20195;&#30721;&#35299;&#26512;</span></p><p class="c1 c7"><span class="c0">&#36213;&#26143;&#23431;</span></p><p class="c1"><span class="c0">&#26412;&#26469;&#26159;&#24819;&#20998;&#26512;&#24494;&#20449;&#30340;libco&#30340;&#25152;&#26377;&#23454;&#29616;&#65292;&#20294;&#26159;&#21457;&#29616;&#20854;&#21487;&#35835;&#24615;&#24182;&#19981;&#39640;&#65292;&#22240;&#32780;&#36873;&#25321;&#20102;&#20113;&#39118;&#21407;&#26469;&#20889;&#36807;&#30340;&#29609;&#20855;&#21327;&#31243;&#24211;coroutine </span><span class="c0 c3"><a class="c5" href="https://www.google.com/url?q=https://github.com/cloudwu/coroutine&amp;sa=D&amp;ust=1478358251889000&amp;usg=AFQjCNE9l0NWlHA5UDWIVUgFg1ZUKEK8gQ">https://github.com/cloudwu/coroutine</a></span><span class="c0">&nbsp;&#12290;&#21644;libco&#19968;&#26679;&#65292;coroutine&#20063;&#20351;&#29992;&#20102;&#20849;&#20139;&#26632;&#65292;&#21363;&#22810;&#20010;&#21327;&#31243;&#30340;&#26632;&#20849;&#29992;&#19968;&#22359;&#20869;&#23384;&#12290;</span></p><p class="c1"><span class="c0">&#21807;&#19968;&#30340;&#35843;&#24230;&#21327;&#31243;&#20351;&#29992;&#31995;&#32479;&#20998;&#37197;&#30340;&#26632;&#31354;&#38388;&#65292;&#22810;&#20010;&#24037;&#20316;&#21327;&#31243;&#20351;&#29992;&#35843;&#24230;&#21327;&#31243;&#22312;&#22534;&#20013;&#20998;&#37197;&#20986;&#26469;&#30340;&#19968;&#22359;&#20869;&#23384;&#20316;&#20026;&#23427;&#20204;&#30340;&#26632;&#12290;</span></p><p class="c1"><span class="c0">&#26412;&#25991;&#19968;&#20849;&#20998;&#20026;&#20197;&#19979;&#19977;&#37096;&#20998;&#36827;&#34892;&#21465;&#36848;&#65306;</span></p><p class="c1"><span class="c4 c0">1&#12289;&#20351;&#29992;&#26041;&#27861;</span></p><p class="c1"><span class="c4 c0">2&#12289;&#38656;&#35201;&#29992;&#21040;&#30340;&#25968;&#25454;&#32467;&#26500;&#19982;&#23439;&#23450;&#20041;</span></p><p class="c1"><span class="c0 c4">3&#12289;&#20855;&#20307;&#24211;&#20989;&#25968;&#20998;&#26512;</span></p><p class="c1 c2"><span class="c4 c0"></span></p><p class="c1"><span class="c4 c0">1&#12289;&#20351;&#29992;&#26041;&#27861;</span></p><p class="c1"><span class="c0">&#20808;&#30475;&#30475;&#20854;&#20351;&#29992;&#26041;&#27861;&#65306;</span><span class="c3 c0"><a class="c5" href="https://www.google.com/url?q=https://github.com/cloudwu/coroutine/blob/master/main.c&amp;sa=D&amp;ust=1478358251892000&amp;usg=AFQjCNFzut4TyPq4tcaUvkn5uv6blyDu-w">https://github.com/cloudwu/coroutine/blob/master/main.c</a></span><span class="c0">&nbsp;</span></p><p class="c1"><span class="c0">int main() {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct schedule * S = coroutine_open();</span></p><p class="c1 c8"><span class="c0">struct args arg1 = { 0 };</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct args arg2 = { 100 };</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int co1 = coroutine_new(S, foo, &amp;arg1);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int co2 = coroutine_new(S, foo, &amp;arg2);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;main start\n&quot;);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (coroutine_status(S,co1) &amp;&amp; coroutine_status(S,co2)) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coroutine_resume(S,co1);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coroutine_resume(S,co2);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;main end\n&quot;);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coroutine_close(S);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#39318;&#20808;&#35843;&#29992;coroutine_open&#20989;&#25968;&#25171;&#24320;&#19968;&#20010;&#35843;&#24230;&#22120;&#12290;</span></p><p class="c1"><span class="c0">&#21019;&#24314;&#21327;&#31243;&#20351;&#29992;coroutine_new&#20989;&#25968;&#20256;&#32473;&#23427;&#35843;&#24230;&#22120;&#65292;&#21327;&#31243;&#35201;&#25191;&#34892;&#30340;&#20989;&#25968;&#21644;&#25351;&#21521;&#20989;&#25968;&#38656;&#35201;&#30340;&#21442;&#25968;&#30340;&#25351;&#38024;&#65292;&#36820;&#22238;&#21019;&#24314;&#30340;&#21327;&#31243;&#30340;&#21327;&#31243;&#21495;&#12290;</span></p><p class="c1"><span class="c0">&#28982;&#21518;&#20998;&#21035;&#21019;&#24314;&#20102;&#20004;&#20010;&#21327;&#31243;co1&#21644;co2&#12290;</span></p><p class="c1"><span class="c0">&#26597;&#30475;&#21327;&#31243;&#29366;&#24577;&#20351;&#29992;coroutine_status&#20989;&#25968;&#65292;&#23427;&#20250;&#36820;&#22238;&#25351;&#23450;&#21327;&#31243;&#30340;&#29366;&#24577;&#20449;&#24687;&#65292;&#20026;0&#34920;&#31034;&#21327;&#31243;&#24050;&#32463;&#36816;&#34892;&#23436;&#27605;&#12290;</span></p><p class="c1"><span class="c0">&#23558;&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#20999;&#25442;&#21040;&#25351;&#23450;&#21327;&#31243;&#20351;&#29992;coroutine_resume&#24674;&#22797;&#21327;&#31243;&#20989;&#25968;&#12290;</span></p><p class="c1"><span class="c0">&#28982;&#21518;&#24490;&#29615;&#21028;&#26029;&#21327;&#31243;1&#21644;&#21327;&#31243;2&#26159;&#21542;&#36816;&#34892;&#23436;&#27605;&#65292;&#22914;&#26524;&#37117;&#27809;&#26377;&#36816;&#34892;&#23436;&#27605;&#21017;&#32487;&#32493;&#24490;&#29615;&#65292;&#21542;&#21017;&#36339;&#20986;&#24490;&#29615;&#12290;&#22312;&#24490;&#29615;&#20013;&#39318;&#20808;&#24674;&#22797;&#21327;&#31243;1&#36816;&#34892;&#65292;&#21327;&#31243;1&#38454;&#27573;&#24615;&#23436;&#25104;&#21518;&#22238;&#21040;&#20027;&#21327;&#31243;&#65292;&#24674;&#22797;&#21327;&#31243;2&#36816;&#34892;&#65292;&#21327;&#31243;2&#38454;&#27573;&#24615;&#23436;&#25104;&#21518;&#22238;&#21040;&#20027;&#21327;&#31243;&#32487;&#32493;&#24490;&#29615;&#12290;</span></p><p class="c1"><span class="c0">&#26368;&#21518;&#35843;&#29992;coroutine_close&#20989;&#25968;&#20851;&#38381;&#25171;&#24320;&#30340;&#35843;&#24230;&#22120;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#21327;&#31243;&#20989;&#25968;&#21644;&#21327;&#31243;&#20989;&#25968;&#38656;&#35201;&#30340;&#21442;&#25968;&#23450;&#20041;&#65306;</span></p><p class="c1"><span class="c0">struct args {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int n;</span></p><p class="c1"><span class="c0">};</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">static void foo(struct schedule * S, void *ud) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct args * arg = ud;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int start = arg-&gt;n;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int i;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0;i&lt;5;i++) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;coroutine %d : %d\n&quot;,coroutine_running(S) , start + i);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coroutine_yield(S);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#21442;&#25968;&#31867;&#22411;&#26080;&#38656;&#22810;&#35328;&#21487;&#20197;&#33258;&#34892;&#23450;&#20041;&#12290;</span></p><p class="c1"><span class="c0">&#23558;&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#24674;&#22797;&#21040;&#20027;&#21327;&#31243;&#20351;&#29992;coroutine_yield&#38454;&#27573;&#24615;&#23436;&#25104;&#20989;&#25968;&#12290;</span></p><p class="c1"><span class="c0">&#21327;&#31243;&#20989;&#25968;&#38656;&#35201;&#20256;&#20837;&#35843;&#24230;&#22120;&#25351;&#38024;&#21644;&#25351;&#21521;&#21327;&#31243;&#21442;&#25968;&#30340;&#25351;&#38024;&#12290;&#26412;&#21327;&#31243;&#20989;&#25968;&#20013;&#65292;&#39318;&#20808;&#21462;&#20986;&#21442;&#25968;&#20013;&#21253;&#35065;&#30340;&#25968;&#25454;&#65292;&#28982;&#21518;&#36827;&#34892;&#20102;5&#27425;&#25171;&#21360;&#21644;&#38454;&#27573;&#24615;&#23436;&#25104;&#25805;&#20316;coroutine_yield&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#31243;&#24207;&#30340;&#36816;&#34892;&#32467;&#26524;&#20026;&#65306;</span></p><p class="c1"><span class="c0">0&#65306;0</span></p><p class="c1"><span class="c0">1&#65306;100</span></p><p class="c1"><span class="c0">0&#65306;1</span></p><p class="c1"><span class="c0">1&#65306;101</span></p><p class="c1"><span class="c0">0&#65306;2</span></p><p class="c1"><span class="c0">1&#65306;102</span></p><p class="c1"><span class="c0">0&#65306;3</span></p><p class="c1"><span class="c0">1&#65306;103</span></p><p class="c1"><span class="c0">0&#65306;4</span></p><p class="c1"><span class="c0">1&#65306;104</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#35843;&#29992;&#27969;&#31243;&#26159;&#65306;</span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 0&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;0&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#36755;&#20986;0&#65306;0</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 1&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;1&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#36755;&#20986;1&#65306;100</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 0&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;0&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#36755;&#20986;0&#65306;1</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 1&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;1&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#36755;&#20986;1&#65306;101</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 0&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;0&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#36755;&#20986;0&#65306;2</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 1&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;1&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#36755;&#20986;1&#65306;102</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 0&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;0&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#36755;&#20986;0&#65306;3</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 1&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;1&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#36755;&#20986;1&#65306;103</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 0&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;0&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#36755;&#20986;0&#65306;4</span></p><p class="c1"><span class="c0">0&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20027;&#21327;&#31243;&#35843;&#29992;coroutine_resume 1&#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;1&#21495;&#21327;&#31243;</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#36755;&#20986;1&#65306;104</span></p><p class="c1"><span class="c0">1&#21495;&#21327;&#31243;&#35843;&#29992;coroutine_yield &#24403;&#21069;&#36816;&#34892;&#21327;&#31243;&#21464;&#20026;&#20027;&#21327;&#31243;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c4 c0">2&#12289;&#38656;&#35201;&#29992;&#21040;&#30340;&#25968;&#25454;&#32467;&#26500;&#19982;&#23439;&#23450;&#20041;</span></p><p class="c1"><span class="c0">#define COROUTINE_DEAD 0</span></p><p class="c1"><span class="c0">#define COROUTINE_READY 1</span></p><p class="c1"><span class="c0">#define COROUTINE_RUNNING 2</span></p><p class="c1"><span class="c0">#define COROUTINE_SUSPEND 3</span></p><p class="c1"><span class="c0">&#19978;&#38754;&#22235;&#20010;&#23439;&#20998;&#21035;&#23450;&#20041;&#20102;&#21327;&#31243;&#30340;&#19981;&#21516;&#29366;&#24577;&#12290;dead&#34920;&#31034;&#21327;&#31243;&#36816;&#34892;&#23436;&#27605;&#65292;ready&#34920;&#31034;&#21327;&#31243;&#21019;&#24314;&#23436;&#27605;&#36824;&#27809;&#26377;&#36816;&#34892;&#65292;running&#34920;&#31034;&#21327;&#31243;&#27491;&#22312;&#36816;&#34892;&#65292;suspend&#34920;&#31034;&#21327;&#31243;&#34987;&#25346;&#36215;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">#define STACK_SIZE (1024*1024)</span></p><p class="c1"><span class="c0">&#26632;&#22823;&#23567;&#23450;&#20041;&#20102;&#25152;&#26377;&#24037;&#20316;&#21327;&#31243;&#20351;&#29992;&#30340;&#26632;&#30340;&#26368;&#22823;&#20540;&#65292;&#20027;&#21327;&#31243;&#20250;&#25353;&#29031;&#36825;&#20010;&#22823;&#23567;&#21435;&#22534;&#20013;&#20998;&#37197;&#19968;&#22359;&#20869;&#23384;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">#define DEFAULT_COROUTINE 16</span></p><p class="c1"><span class="c0">&#40664;&#35748;&#21327;&#31243;&#25968;&#25351;&#23450;&#20102;&#35843;&#24230;&#22120;&#20013;&#23384;&#25918;&#21327;&#31243;&#25351;&#38024;&#30340;&#23481;&#22120;&#30340;&#21021;&#22987;&#20540;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">struct schedule {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char stack[STACK_SIZE];</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ucontext_t main;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int nco;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int cap;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int running;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine **co;</span></p><p class="c1"><span class="c0">};</span></p><p class="c1"><span class="c0">&#35843;&#24230;&#22120;&#32467;&#26500;&#20307;&#65292;&#20854;&#20013;&#23384;&#25918;&#20102;&#65306;</span></p><p class="c1"><span class="c0">stack &#22810;&#20010;&#24037;&#20316;&#21327;&#31243;&#20849;&#29992;&#30340;&#26632;&#31354;&#38388;</span></p><p class="c1"><span class="c0">main &#20027;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;</span></p><p class="c1"><span class="c0">nco &#24037;&#20316;&#21327;&#31243;&#30340;&#25968;&#37327;</span></p><p class="c1"><span class="c0">cap &#23384;&#25918;&#24037;&#20316;&#21327;&#31243;&#30340;&#23481;&#22120;&#30340;&#23481;&#37327;&#65292;&#22914;&#26524;&#36229;&#36807;&#23481;&#37327;&#20250;&#37325;&#26032;&#20998;&#37197;&#20869;&#23384;</span></p><p class="c1"><span class="c0">running &#27491;&#22312;&#36816;&#34892;&#30340;&#24037;&#20316;&#21327;&#31243;&#21495;</span></p><p class="c1"><span class="c0">co &#24037;&#20316;&#21327;&#31243;&#30340;&#25351;&#38024;&#25968;&#32452;&#65292;&#21363;&#23384;&#25918;&#25351;&#21521;&#24037;&#20316;&#21327;&#31243;&#30340;&#25351;&#38024;&#30340;&#23481;&#22120;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">typedef void (*coroutine_func)(struct schedule *, void *ud);</span></p><p class="c1"><span class="c0">&#21327;&#31243;&#20989;&#25968;&#31867;&#22411;&#23450;&#20041;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">struct coroutine {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coroutine_func func;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void *ud;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ucontext_t ctx;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct schedule * sch;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptrdiff_t cap;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptrdiff_t size;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int status;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char *stack;</span></p><p class="c1"><span class="c0">};</span></p><p class="c1"><span class="c0">&#21327;&#31243;&#32467;&#26500;&#20307;&#65292;&#20854;&#20013;&#23384;&#25918;&#20102;&#65306;</span></p><p class="c1"><span class="c0">func &#21327;&#31243;&#20989;&#25968;&#30340;&#20989;&#25968;&#25351;&#38024;</span></p><p class="c1"><span class="c0">ud &#25351;&#21521;&#21327;&#31243;&#20989;&#25968;&#21442;&#25968;&#30340;&#25351;&#38024;</span></p><p class="c1"><span class="c0">ctx &#21327;&#31243;&#19978;&#19979;&#25991;</span></p><p class="c1"><span class="c0">sch &#25351;&#21521;&#35843;&#24230;&#22120;&#30340;&#25351;&#38024;</span></p><p class="c1"><span class="c0">stack &#24403;&#21327;&#31243;&#25442;&#20986;&#26102;&#29992;&#20110;&#23384;&#25918;&#24403;&#21069;&#26632;&#20869;&#23481;&#30340;&#23481;&#22120;</span></p><p class="c1"><span class="c0">cap stack&#23481;&#22120;&#30340;&#23481;&#37327;</span></p><p class="c1"><span class="c0">size stack&#23481;&#22120;&#30446;&#21069;&#20351;&#29992;&#30340;&#22823;&#23567;</span></p><p class="c1"><span class="c0">status &#24403;&#21069;&#21327;&#31243;&#30340;&#29366;&#24577;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c4 c0">3&#12289;&#20855;&#20307;&#24211;&#20989;&#25968;&#20998;&#26512;</span></p><p class="c1"><span class="c0">&#20808;&#30475;&#31616;&#21333;&#30340;&#25171;&#24320;&#21644;&#20851;&#38381;&#35843;&#24230;&#22120;&#20989;&#25968;&#65306;</span></p><p class="c1"><span class="c0">struct schedule * coroutine_open(void) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct schedule *S = malloc(sizeof(*S));</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;nco = 0;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;cap = DEFAULT_COROUTINE;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;running = -1;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;co = malloc(sizeof(struct coroutine *) * S-&gt;cap);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset(S-&gt;co, 0, sizeof(struct coroutine *) * S-&gt;cap);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return S;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#25171;&#24320;&#35843;&#24230;&#22120;&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#22522;&#26412;&#19978;&#23601;&#26159;&#20998;&#37197;&#19968;&#20010;&#35843;&#24230;&#22120;&#23545;&#35937;&#65292;&#28982;&#21518;&#23558;&#20854;&#32447;&#31243;&#25968;&#35774;&#32622;&#20026;0&#65292;&#23558;&#20854;&#32447;&#31243;&#23481;&#37327;&#35774;&#32622;&#20026;&#40664;&#35748;&#23481;&#37327;&#65292;&#23558;&#20854;&#27491;&#22312;&#36816;&#34892;&#30340;&#21327;&#31243;&#21495;&#35774;&#32622;&#20026;-1&#21363;&#20027;&#21327;&#31243;&#65292;&#23558;&#20854;&#23384;&#25918;&#25351;&#21521;&#24037;&#20316;&#21327;&#31243;&#30340;&#25351;&#38024;&#30340;&#23481;&#22120;&#25353;&#29031;&#23481;&#37327;&#20998;&#37197;&#22909;&#12290;&#36825;&#37324;&#27809;&#26377;&#25552;&#21040;&#65292;&#20854;&#23454;&#22312;&#20998;&#37197;&#35843;&#24230;&#22120;&#30340;&#26102;&#20505;&#20854;&#20013;&#30340;&#20027;&#21327;&#31243;&#19978;&#19979;&#25991;&#21644;&#22810;&#20010;&#24037;&#20316;&#21327;&#31243;&#20849;&#29992;&#30340;&#26632;&#31354;&#38388;&#20063;&#20998;&#37197;&#22909;&#20102;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">void coroutine_close(struct schedule *S) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int i;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0;i&lt;S-&gt;cap;i++) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine * co = S-&gt;co[i];</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (co) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_co_delete(co);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(S-&gt;co);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;co = NULL;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(S);</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#20851;&#38381;&#35843;&#24230;&#22120;&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#26159;&#65306;&#23558;&#35843;&#24230;&#22120;&#37324;&#38754;&#30340;&#23384;&#25918;&#25351;&#21521;&#24037;&#20316;&#21327;&#31243;&#30340;&#25351;&#38024;&#30340;&#23481;&#22120;&#20013;&#30340;&#21327;&#31243;&#21344;&#29992;&#30340;&#20869;&#23384;&#35843;&#29992;_co_delete&#37322;&#25918;&#25481;&#65292;&#24182;&#19988;&#23558;&#23481;&#22120;&#21344;&#29992;&#30340;&#20869;&#23384;&#20063;&#37322;&#25918;&#25481;&#24182;&#19988;&#32622;&#31354;&#65292;&#26368;&#21518;&#23558;&#35843;&#24230;&#22120;&#21344;&#29992;&#30340;&#20869;&#23384;&#20063;&#37322;&#25918;&#25481;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">coroutine_close&#20989;&#25968;&#20013;&#35843;&#29992;&#30340;_co_delete&#20989;&#25968;&#23454;&#29616;&#22914;&#19979;&#65306;</span></p><p class="c1"><span class="c0">void _co_delete(struct coroutine *co) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(co-&gt;stack);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(co);</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#21024;&#38500;&#21327;&#31243;&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#26159;&#65306;&#23558;&#21327;&#31243;&#20013;&#29992;&#20110;&#25442;&#20986;&#21518;&#23384;&#25918;&#26632;&#30340;&#20869;&#23384;&#37322;&#25918;&#25481;&#65292;&#26368;&#21518;&#23558;&#21327;&#31243;&#20063;&#37322;&#25918;&#25481;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20877;&#30475;&#30475;&#21019;&#24314;&#21327;&#31243;&#30340;&#20989;&#25968;&#65306;</span></p><p class="c1"><span class="c0">struct coroutine * _co_new(struct schedule *S , coroutine_func func, void *ud) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine * co = malloc(sizeof(*co));</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;func = func;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;ud = ud;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;sch = S;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;cap = 0;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;size = 0;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;status = COROUTINE_READY;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;co-&gt;stack = NULL;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return co;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#21327;&#31243;&#26500;&#36896;&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#26159;&#65306;&#20998;&#37197;&#21327;&#31243;&#25152;&#38656;&#35201;&#30340;&#20869;&#23384;&#65292;&#24182;&#19988;&#23558;&#20854;&#20013;&#30340;&#21327;&#31243;&#20989;&#25968;&#65292;&#25351;&#21521;&#21327;&#31243;&#20989;&#25968;&#21442;&#25968;&#30340;&#25351;&#38024;&#65292;&#21644;&#35843;&#24230;&#22120;&#25351;&#38024;&#25353;&#29031;&#21442;&#25968;&#36827;&#34892;&#21021;&#22987;&#21270;&#65292;&#28982;&#21518;&#23558;&#20854;&#25442;&#20986;&#21518;&#30340;&#26632;&#31354;&#38388;&#32622;&#31354;&#65292;&#20854;&#23481;&#37327;&#21644;&#22823;&#23567;&#37117;&#35774;&#32622;&#20026;0&#65292;&#26368;&#21518;&#23558;&#21327;&#31243;&#29366;&#24577;&#32622;&#20026;&#23601;&#32490;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">int coroutine_new(struct schedule *S, coroutine_func func, void *ud) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine *co = _co_new(S, func , ud);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (S-&gt;nco &gt;= S-&gt;cap) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int id = S-&gt;cap;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;co = realloc(S-&gt;co, S-&gt;cap * 2 * sizeof(struct coroutine *));</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset(S-&gt;co + S-&gt;cap , 0 , sizeof(struct coroutine *) * S-&gt;cap);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;co[S-&gt;cap] = co;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;cap *= 2;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++S-&gt;nco;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return id;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int i;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (i=0;i&lt;S-&gt;cap;i++) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int id = (i+S-&gt;nco) % S-&gt;cap;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (S-&gt;co[id] == NULL) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;co[id] = co;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++S-&gt;nco;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return id;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(0);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -1;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#21019;&#24314;&#21327;&#31243;&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#26159;&#65306;&#39318;&#20808;&#35843;&#29992;_co_new&#21019;&#24314;&#19968;&#20010;&#21327;&#31243;&#23545;&#35937;&#65292;&#28982;&#21518;&#23558;&#20854;&#25554;&#20837;&#35843;&#24230;&#22120;&#30340;&#21327;&#31243;&#25351;&#38024;&#25968;&#32452;&#23481;&#22120;&#20013;&#65292;&#24182;&#19988;&#36820;&#22238;&#20854;&#22312;&#23481;&#22120;&#20013;&#30340;&#32534;&#21495;&#12290;&#24403;&#21327;&#31243;&#25968;&#36798;&#21040;&#26368;&#22823;&#23481;&#37327;&#30340;&#26102;&#20505;&#20250;&#36827;&#34892;&#25193;&#23481;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#21040;&#20102;&#26368;&#20851;&#38190;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#26469;&#20998;&#26512;resume&#20989;&#25968;&#21644;yield&#20989;&#25968;&#65306;</span></p><p class="c1"><span class="c0">void coroutine_resume(struct schedule * S, int id) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(S-&gt;running == -1);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(id &gt;=0 &amp;&amp; id &lt; S-&gt;cap);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine *C = S-&gt;co[id];</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (C == NULL)</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int status = C-&gt;status;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(status) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case COROUTINE_READY:</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getcontext(&amp;C-&gt;ctx);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;ctx.uc_stack.ss_sp = S-&gt;stack;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;ctx.uc_stack.ss_size = STACK_SIZE;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;ctx.uc_link = &amp;S-&gt;main;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;running = id;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;status = COROUTINE_RUNNING;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uintptr_t ptr = (uintptr_t)S;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;makecontext(&amp;C-&gt;ctx, (void (*)(void)) mainfunc, 2, (uint32_t)ptr, (uint32_t)(ptr&gt;&gt;32));</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;swapcontext(&amp;S-&gt;main, &amp;C-&gt;ctx);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case COROUTINE_SUSPEND:</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy(S-&gt;stack + STACK_SIZE - C-&gt;size, C-&gt;stack, C-&gt;size);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;running = id;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;status = COROUTINE_RUNNING;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;swapcontext(&amp;S-&gt;main, &amp;C-&gt;ctx);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(0);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#39318;&#20808;&#20998;&#26512;resume&#20989;&#25968;&#65292;&#20854;&#20027;&#35201;&#20570;&#30340;&#26159;&#65306;&#39318;&#20808;&#20174;&#35843;&#24230;&#22120;&#30340;&#21327;&#31243;&#25351;&#38024;&#23481;&#22120;&#20013;&#26681;&#25454;&#21327;&#31243;&#21495;&#33719;&#21462;&#23545;&#24212;&#30340;&#21327;&#31243;&#12290;&#28982;&#21518;&#21028;&#26029;&#35813;&#21327;&#31243;&#26159;&#21542;&#20026;&#31354;&#65292;&#22914;&#26524;&#20026;&#31354;&#21017;&#30452;&#25509;&#36820;&#22238;&#12290;&#21542;&#21017;&#26681;&#25454;&#21327;&#31243;&#30340;&#29366;&#24577;&#20449;&#24687;&#36827;&#34892;&#22788;&#29702;&#65292;&#27492;&#26102;&#21327;&#31243;&#21482;&#21487;&#33021;&#26377;&#20004;&#20010;&#29366;&#24577;&#23601;&#32490;&#21644;&#25346;&#36215;&#12290;&#19981;&#21487;&#33021;&#26159;dead&#26159;&#22240;&#20026;&#36825;&#26679;&#20250;&#25214;&#19981;&#21040;&#35813;&#21327;&#31243;&#65292;&#19981;&#21487;&#33021;&#26159;&#27491;&#22312;&#36816;&#34892;&#26159;&#22240;&#20026;&#24403;&#21069;&#27491;&#22312;&#36816;&#34892;&#30340;&#26159;&#20027;&#21327;&#31243;&#12290;</span></p><p class="c1"><span class="c0">&#22914;&#26524;&#26159;&#23601;&#32490;&#29366;&#24577;&#21017;&#65292;&#39318;&#20808;&#35843;&#29992;getcontext&#32473;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#20570;&#22909;&#21021;&#22987;&#21270;&#24037;&#20316;&#12290;&#28982;&#21518;&#32473;&#20854;ss_sp&#35774;&#32622;&#20026;&#20849;&#20139;&#26632;&#30340;&#26368;&#22823;&#26632;&#39030;&#65292;&#32473;&#20854;ss_size&#35774;&#32622;&#20026;&#20849;&#20139;&#26632;&#30340;&#26368;&#22823;&#22823;&#23567;&#65292;&#32473;&#20854;link&#35774;&#32622;&#20026;&#25351;&#21521;&#20027;&#21327;&#31243;&#19978;&#19979;&#25991;&#30340;&#25351;&#38024;&#12290;&#28982;&#21518;&#32473;&#21327;&#31243;&#30340;&#29366;&#24577;&#35774;&#32622;&#20026;&#36816;&#34892;&#29366;&#24577;&#65292;&#24182;&#19988;&#23558;&#35843;&#24230;&#22120;&#20013;&#36816;&#34892;&#30340;&#21327;&#31243;&#21495;&#35774;&#32622;&#20026;&#36825;&#20010;&#21327;&#31243;&#12290;&#28982;&#21518;&#35843;&#29992;&#20102;makecontext(&amp;C-&gt;ctx, (void (*)(void)) mainfunc, 2, (uint32_t)ptr, (uint32_t)(ptr&gt;&gt;32))&#65292;&#36825;&#20010;&#20989;&#25968;&#20570;&#30340;&#24037;&#20316;&#21487;&#20197;&#20351;&#29992;&#21069;&#38754;&#22312;&#20998;&#26512;libco&#37324;&#38754;&#30340;coctx_make&#26469;&#35299;&#37322;&#12290;</span></p><p class="c1"><span class="c0">int coctx_make(coctx_t *ctx,coctx_pfn_t pfn,const void *s,const void *s1)</span></p><p class="c1"><span class="c0">{</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//make room for coctx_param</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char *sp = ctx-&gt;ss_sp + ctx-&gt;ss_size - sizeof(coctx_param_t);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp = (char*)((unsigned long)sp &amp; -16L);</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coctx_param_t* param = (coctx_param_t*)sp ;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param-&gt;s1 = s;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;param-&gt;s2 = s1;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset(ctx-&gt;regs, 0, sizeof(ctx-&gt;regs));</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctx-&gt;regs[ kESP ] = (char*)(sp) - sizeof(void*);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctx-&gt;regs[ kEIP ] = (char*)pfn;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">coctx_make&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#26159;&#65306;&#36825;&#37324;&#20998;&#26512;i386&#29256;&#26412;&#65292;&#39318;&#20808;&#23558;sp&#25351;&#21521;&#26632;&#24213;&#20445;&#30041;&#30340;param&#23545;&#35937;&#65292;&#24182;&#19988;&#23545;&#20854;&#20869;&#23384;&#21040;16&#23383;&#33410;&#65292;&#23558;&#21442;&#25968;s,s1&#35774;&#32622;&#21040;param&#23545;&#35937;&#20013;&#27169;&#20223;&#21442;&#25968;&#20256;&#36882;&#65292;&#28982;&#21518;&#23545;&#35813;&#19978;&#19979;&#25991;&#25152;&#26377;&#23492;&#23384;&#22120;&#28165;&#31354;&#20869;&#23384;&#65292;&#23558;esp&#35774;&#32622;&#20026;&#25351;&#21521;&#24403;&#21069;&#26632;&#39030;&#65292;&#23558;eip&#35774;&#32622;&#20026;&#20256;&#36882;&#36827;&#26469;&#30340;&#20989;&#25968;&#25351;&#38024;&#65292;&#20197;&#22791;&#19978;&#19979;&#25991;&#20999;&#25442;&#12290;&#36825;&#37324;&#27809;&#26377;&#35752;&#35770;link&#30340;&#38382;&#39064;&#65292;&#21518;&#38754;&#20250;&#32487;&#32493;&#35828;&#12290;&#36825;&#37324;&#20026;&#20160;&#20040;&#35201;&#20256;&#36882;&#20004;&#20010;&#21442;&#25968;&#21602;&#65311;&#26159;&#20026;&#20102;&#19982;x86-64&#30340;edi, esi&#20004;&#20010;&#23492;&#23384;&#22120;&#24517;&#39035;&#20256;&#36882;&#20004;&#20010;&#21442;&#25968;&#20570;&#20860;&#23481;&#12290;</span></p><p class="c1"><span class="c0">&#22871;&#29992;&#22312;makecontext(&amp;C-&gt;ctx, (void (*)(void)) mainfunc, 2, (uint32_t)ptr, (uint32_t)(ptr&gt;&gt;32))&#19978;&#38754;&#23601;&#26159;&#35828;&#65292;&#20250;&#23558;mainfunc&#20989;&#25968;&#25351;&#38024;&#35774;&#32622;&#20026;&#21327;&#31243;&#19978;&#19979;&#25991;&#20013;&#30340;eip&#65292;&#23558;ptr&#21644;ptr&gt;&gt;32&#24403;&#20316;&#21442;&#25968;&#25918;&#21040;&#19978;&#19979;&#25991;&#20013;&#25351;&#23450;&#30340;&#26632;&#19978;&#65292;&#24182;&#19988;&#35774;&#32622;&#19978;&#19979;&#25991;&#20013;&#30340;esp&#12290;</span></p><p class="c1"><span class="c0">&#26368;&#21518;&#35843;&#29992;swapcontext&#65292;&#23558;&#24403;&#21069;&#19978;&#19979;&#25991;&#20445;&#23384;&#21040;&#20027;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#20013;&#65292;&#24182;&#19988;&#23558;&#30446;&#26631;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#32622;&#20026;&#24403;&#21069;&#19978;&#19979;&#25991;&#65292;&#21363;&#36339;&#36716;&#21040;eip&#25351;&#21521;&#30340;&#22320;&#22336;&#65292;esp&#20026;&#26632;&#39030;&#25351;&#38024;&#65292;&#36827;&#20837;&#20989;&#25968;&#21518;&#20250;&#21021;&#22987;&#21270;ebp&#12290;&#20855;&#20307;&#20998;&#26512;&#35265;&#25105;&#30340;&#19978;&#19968;&#31687;&#21338;&#23458;</span><span class="c3 c0"><a class="c5" href="https://www.google.com/url?q=https://zxylvlp.github.io/blog/coctx_swap.html&amp;sa=D&amp;ust=1478358251975000&amp;usg=AFQjCNH_gs1Dk98AomOTZ0eR0uLxrzd6WA">https://zxylvlp.github.io/blog/coctx_swap.html</a></span><span class="c0">&nbsp;&#12290;&#36825;&#26102;&#25105;&#20204;&#23601;&#35843;&#24230;&#20102;&#35813;&#21327;&#31243;&#65292;&#24403;&#35813;&#21327;&#31243;yield&#25110;&#32773;&#23436;&#25104;&#26102;&#20250;&#22238;&#21040;&#20027;&#21327;&#31243;&#19978;&#19979;&#25991;&#32487;&#32493;&#25191;&#34892;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#21018;&#21018;&#35752;&#35770;&#20102;&#23601;&#32490;&#29366;&#24577;&#30340;&#22788;&#29702;&#65292;&#29616;&#22312;&#26469;&#30475;&#30475;&#25346;&#36215;&#29366;&#24577;&#30340;&#22788;&#29702;&#12290;&#39318;&#20808;&#23558;&#21327;&#31243;&#20445;&#23384;&#30340;&#25442;&#20986;&#21069;&#30340;&#26632;&#22797;&#21046;&#21040;&#35843;&#24230;&#22120;&#30340;&#20849;&#20139;&#26632;&#20013;&#12290;&#28982;&#21518;&#32473;&#21327;&#31243;&#30340;&#29366;&#24577;&#35774;&#32622;&#20026;&#36816;&#34892;&#29366;&#24577;&#65292;&#24182;&#19988;&#23558;&#35843;&#24230;&#22120;&#20013;&#36816;&#34892;&#30340;&#21327;&#31243;&#21495;&#35774;&#32622;&#20026;&#36825;&#20010;&#21327;&#31243;&#12290;&#26368;&#21518;&#35843;&#29992;&#20102;swapcontext&#65292;&#23558;&#24403;&#21069;&#19978;&#19979;&#25991;&#20445;&#23384;&#21040;&#20027;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#20013;&#65292;&#24182;&#19988;&#23558;&#30446;&#26631;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#32622;&#20026;&#24403;&#21069;&#19978;&#19979;&#25991;&#65292;&#36339;&#20837;&#21327;&#31243;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#20854;&#20013;&#29992;&#21040;&#20102;mainfunc&#20989;&#25968;&#65292;&#29616;&#22312;&#35752;&#35770;&#20855;&#20307;&#32454;&#33410;&#65306;</span></p><p class="c1"><span class="c0">static void mainfunc(uint32_t low32, uint32_t hi32) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uintptr_t ptr = (uintptr_t)low32 | ((uintptr_t)hi32 &lt;&lt; 32);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct schedule *S = (struct schedule *)ptr;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int id = S-&gt;running;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine *C = S-&gt;co[id];</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;func(S,C-&gt;ud);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_co_delete(C);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;co[id] = NULL;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--S-&gt;nco;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;running = -1;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#26681;&#25454;&#21442;&#25968;&#25340;&#20986;&#35843;&#24230;&#22120;&#25351;&#38024;&#65292;&#20174;&#20013;&#25214;&#21040;&#24403;&#21069;&#21327;&#31243;&#65292;&#24182;&#19988;&#35843;&#29992;&#24403;&#21069;&#21327;&#31243;&#30340;&#21327;&#31243;&#20989;&#25968;&#65292;&#35843;&#29992;&#23436;&#27605;&#21518;&#35843;&#29992;_co_delete&#26512;&#26500;&#21327;&#31243;&#65292;&#24182;&#19988;&#23558;&#35813;&#21327;&#31243;&#22312;&#35843;&#24230;&#22120;&#23481;&#22120;&#20013;&#30340;&#25351;&#38024;&#32622;&#31354;&#65292;&#23558;&#21327;&#31243;&#25968;&#20943;1&#65292;&#23558;&#36816;&#34892;&#30340;&#21327;&#31243;&#32622;&#20026;&#20027;&#21327;&#31243;&#12290;</span></p><p class="c1"><span class="c0">&#27880;&#24847;&#22312;&#24403;&#21069;&#23454;&#29616;&#20013;&#24403;mainfunc&#36820;&#22238;&#30340;&#26102;&#20505;&#65292;&#20854;&#27809;&#26377;&#36820;&#22238;&#22320;&#22336;&#24182;&#19988;pop ebp&#20063;&#20250;&#32473;&#20854;&#28165;&#38646;&#65292;&#22914;&#26524;&#36820;&#22238;&#20250;&#20986;&#38169;&#65292;&#25152;&#20197;&#24403;&#20854;&#36820;&#22238;&#30340;&#26102;&#20505;&#38656;&#35201;&#21152;1&#26465;setcontext&#65292;&#23558;&#19978;&#19979;&#25991;&#35774;&#32622;&#20026;&#20027;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#65292;&#22914;&#26524;&#19981;&#21152;&#21487;&#20197;&#36890;&#36807;&#22810;&#21253;&#35065;1&#23618;&#21152;&#20102;&#30340;&#20989;&#25968;&#26469;&#23454;&#29616;&#12290;&#36825;&#37324;&#30340;link&#23601;&#26159;&#36825;&#20010;&#20316;&#29992;&#65292;&#25351;&#23450;&#26368;&#21518;setcontext&#30340;&#19978;&#19979;&#25991;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">void coroutine_yield(struct schedule * S) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int id = S-&gt;running;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(id &gt;= 0);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct coroutine * C = S-&gt;co[id];</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert((char *)&amp;C &gt; S-&gt;stack);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_save_stack(C,S-&gt;stack + STACK_SIZE);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;status = COROUTINE_SUSPEND;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S-&gt;running = -1;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;swapcontext(&amp;C-&gt;ctx , &amp;S-&gt;main);</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">coroutine_yield&#20989;&#25968;&#20570;&#30340;&#20107;&#24773;&#26159;&#65306;&#26681;&#25454;&#24403;&#21069;&#36816;&#34892;&#30340;&#21327;&#31243;&#21495;&#21363;&#33258;&#24049;&#30340;&#21327;&#31243;&#21495;&#21435;&#35843;&#24230;&#22120;&#20013;&#25214;&#21040;&#25351;&#21521;&#33258;&#24049;&#21327;&#31243;&#30340;&#25351;&#38024;&#65292;&#28982;&#21518;&#35843;&#29992;_save_stack&#23558;&#24403;&#21069;&#20351;&#29992;&#30340;&#26632;&#25335;&#36125;&#21040;&#21327;&#31243;&#20013;&#12290;&#23558;&#21327;&#31243;&#30340;&#29366;&#24577;&#32622;&#20026;&#25346;&#36215;&#29366;&#24577;&#65292;&#24182;&#19988;&#23558;&#35843;&#24230;&#22120;&#36816;&#34892;&#30340;&#21327;&#31243;&#32622;&#20026;&#20027;&#21327;&#31243;&#12290;&#26368;&#21518;&#35843;&#29992;swapcontext&#23558;&#24403;&#21069;&#19978;&#19979;&#25991;&#20445;&#23384;&#21040;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#20013;&#65292;&#24182;&#19988;&#23558;&#20027;&#21327;&#31243;&#30340;&#19978;&#19979;&#25991;&#35774;&#32622;&#20026;&#24403;&#21069;&#19978;&#19979;&#25991;&#65292;&#36339;&#22238;&#20027;&#21327;&#31243;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#22312;coroutine_yield&#20989;&#25968;&#20013;&#29992;&#21040;&#20102;_save_stack&#20445;&#23384;&#24403;&#21069;&#21327;&#31243;&#20351;&#29992;&#30340;&#26632;&#12290;&#20855;&#20307;&#20998;&#26512;&#22914;&#19979;&#65306;</span></p><p class="c1"><span class="c0">static void _save_stack(struct coroutine *C, char *top) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char dummy = 0;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(top - &amp;dummy &lt;= STACK_SIZE);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (C-&gt;cap &lt; top - &amp;dummy) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(C-&gt;stack);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;cap = top-&amp;dummy;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;stack = malloc(C-&gt;cap);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C-&gt;size = top - &amp;dummy;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy(C-&gt;stack, &amp;dummy, C-&gt;size);</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">&#39318;&#20808;&#21019;&#24314;&#19968;&#20010;&#23616;&#37096;&#21464;&#37327;&#65292;&#24182;&#19988;&#33719;&#21462;&#20854;&#22320;&#22336;&#20316;&#20026;&#26632;&#39030;&#22320;&#22336;&#65292;&#28982;&#21518;&#21028;&#26029;&#21327;&#31243;&#20013;&#29992;&#20110;&#23384;&#25918;&#26632;&#30340;&#23481;&#22120;&#30340;&#23481;&#37327;&#26159;&#21542;&#36275;&#22815;&#65292;&#22914;&#26524;&#19981;&#22815;&#21017;&#37325;&#26032;&#30003;&#35831;&#12290;&#23558;&#23481;&#22120;&#20351;&#29992;&#37327;&#32622;&#20026;&#26632;&#30340;&#22823;&#23567;&#65292;&#24182;&#19988;&#23558;&#25972;&#20010;&#26632;&#25335;&#36125;&#21040;&#23481;&#22120;&#20013;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">&#26368;&#21518;&#36824;&#26377;&#20004;&#20010;&#31616;&#21333;&#30340;&#20989;&#25968;&#65306;</span></p><p class="c1"><span class="c0">int coroutine_status(struct schedule * S, int id) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert(id&gt;=0 &amp;&amp; id &lt; S-&gt;cap);</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (S-&gt;co[id] == NULL) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return COROUTINE_DEAD;</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return S-&gt;co[id]-&gt;status;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">coroutine_status&#20989;&#25968;&#20250;&#36820;&#22238;&#25351;&#23450;&#21327;&#31243;&#30340;&#29366;&#24577;&#65292;&#23427;&#20250;&#21435;&#35843;&#24230;&#22120;&#30340;&#21327;&#31243;&#23481;&#22120;&#20013;&#26681;&#25454;&#21327;&#31243;&#21495;&#21435;&#25214;&#65292;&#19981;&#36807;&#25214;&#19981;&#21040;&#30340;&#36820;&#22238;dead&#29366;&#24577;&#65292;&#22914;&#26524;&#25214;&#21040;&#20102;&#21017;&#36820;&#22238;&#35813;&#21327;&#31243;&#30340;&#29366;&#24577;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1"><span class="c0">int coroutine_running(struct schedule * S) {</span></p><p class="c1"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return S-&gt;running;</span></p><p class="c1"><span class="c0">}</span></p><p class="c1"><span class="c0">coroutine_running&#20989;&#25968;&#20250;&#36820;&#22238;&#24403;&#21069;&#21327;&#31243;&#30340;&#21327;&#31243;&#21495;&#12290;</span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p><p class="c1 c2"><span class="c0"></span></p></body></html>